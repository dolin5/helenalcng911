// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../layers/support/FieldsIndex","../../../../../support/arcadeOnDemand","../../../../webgl","../../../engine","../../../arcade/utils","../../../engine/webgl/definitions","../tileRenderers/support/visualVariablesUtils","@dojo/framework/shim/Promise"],function(t,e,i,r,n,s,a,o,u,l,c,h,p,d,f,_,y){Object.defineProperty(e,"__esModule",{value:!0});var g=(p.enums.PixelType,a.getLogger("esri.views.layers.2d.features.support.AttributeStore")),b=d.debug.createDebugLogger(d.debug.DEBUG_ATTR_UPDATES,g),v=function(t,e){return function(i,r,n){var s;try{s=e(i,r,n)}catch(t){s=NaN}return(null===s||isNaN(s)||s===1/0)&&t||s}},m={sharedArrayBuffer:s("esri-shared-array-buffer"),oesTextureFloat:s("esri-webgl-texture-float"),maxTextureSize:s("esri-webgl-max-texture-size"),atomics:s("esri-atomics")},x=function(){function t(t,e,i,r){this.texelSize=4;var n=r.pixelType,s=r.layout,a=r.textureOnly;this.textureOnly=a||!1,this.pixelType=n,this._ctype=e,this.layout=s,this._resetRange(),this._shared=t,a||(this.data=this._initData(n,i,t,e))}return Object.defineProperty(t.prototype,"buffer",{get:function(){return u.andThen(this.data,function(t){return t.buffer})},enumerable:!0,configurable:!0}),t.prototype.getData=function(t,e){return u.expect(this.data)[t*this.texelSize+e]},t.prototype.setData=function(t,e,i,r){void 0===r&&(r=!0);var n=1<<e;if(0==(this.layout&n))return void g.error("mapview-attributes-store","Tried to set a value for a texel's readonly component");this.data[t*this.texelSize+e]=i,this.dirtyStart=Math.min(this.dirtyStart,t),this.dirtyEnd=Math.max(this.dirtyEnd,t)},t.prototype.lock=function(){if(s("esri-2d-debug")&&5121===this.pixelType)return void g.error("AttributeStore-Bad-Type","Tried to lock non integer array type with float array");this._shared&&m.atomics&&Atomics.store(this.data,0,1)},t.prototype.unlock=function(){if(s("esri-2d-debug")&&5121===this.pixelType)return void g.error("AttributeStore-Bad-Type","Tried to unlock non integer array type with float array");this._shared&&m.atomics&&Atomics.store(this.data,0,0)},t.prototype.expand=function(t){if(!this.textureOnly){var e=this._initData(this.pixelType,t,this._shared,this._ctype),i=u.expect(this.data);e.set(i),this.data=e}},t.prototype.toMessage=function(){var t=this.dirtyStart,e=this.dirtyEnd,i=this.texelSize;if(t>e)return null;this._resetRange();var r=!(this._shared||"local"===this._ctype),n=this.pixelType,s=this.layout,a=u.expect(this.data);if(!a.slice){if(!r)return{start:t,end:e,data:null,pixelType:n,layout:s};return{start:t,end:e,data:new(d.Utils.getPixelArrayCtor(this.pixelType))(Array.prototype.slice.call(this.data,t*i,(e+1)*i)),pixelType:n,layout:s}}return{start:t,end:e,data:r&&a.slice(t*i,(e+1)*i)||null,pixelType:n,layout:s}},t.prototype._initData=function(t,e,i,r){for(var n=i&&"local"!==r?SharedArrayBuffer:ArrayBuffer,s=d.Utils.getPixelArrayCtor(t),a=s.BYTES_PER_ELEMENT,o=new s(new n(e*e*4*a)),u=0;u<o.length;u+=4)o[u+1]=255;return o},t.prototype._resetRange=function(){this.dirtyStart=4294967295,this.dirtyEnd=0},t}(),T=function(){function e(t){this._attributeComputeMap=new Map,this._blocks=new Array,this._idMap=new Map,this._localToObjectId=new Map,this._filters=new Array(d.definitions.MAX_FILTERS),this._freeList=[],this._abortController=l.createAbortController(),this._hasScaleExpr=!1,this._size=32,this._idCounter=1,this._idsToHighlight=new Set;var e=m.oesTextureFloat?5126:5121;b("Creating AttributeStore "+(m.sharedArrayBuffer?"with":"without")+" shared memory"),s("esri-2d-debug")&&m.sharedArrayBuffer&&!m.atomics&&g.warn("Browser supports SharedArrayBuffer but not Atomics. Rendering may be impacted"),this._client=t,this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:e,layout:15},{pixelType:e,layout:15}],this._blocks=this._blockDescriptors.map(function(t){return null})}return e.prototype.destroy=function(){this._abortController.abort()},Object.defineProperty(e.prototype,"hasScaleExpr",{get:function(){return this._hasScaleExpr},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_signal",{get:function(){return this._abortController.signal},enumerable:!0,configurable:!0}),e.prototype.createLocalId=function(t){if(!this._idMap.has(t)){var e=this._getFreeId();this._idMap.set(t,-1===e?0:e),this._localToObjectId.set(e,t)}return this._idMap.get(t)},e.prototype.freeLocalId=function(t){var e=this._idMap.get(t);this._idMap.delete(t),this._localToObjectId.delete(e),this._freeList.push(e)},e.prototype.getFeatureId=function(t){return this._localToObjectId.get(t)},e.prototype.getLocalId=function(t){return this._idMap.has(t)?this._idMap.get(t):null},e.prototype.setHighlight=function(t){return r(this,void 0,void 0,function(){var e,r,n,s,a,o,u,l=this;return i(this,function(i){switch(i.label){case 0:for(e=1,this._getBlock(0).lock(),this._idsToHighlight.forEach(function(t){var i=l.getLocalId(t);if(i){var r=l._getBlock(0).getData(i,0);l._getBlock(0).setData(i,0,r&~e)}}),this._idsToHighlight.clear(),r=0,n=t;r<n.length;r++)s=n[r],this._idsToHighlight.add(s);for(a=0;a<t.length;a++)null!=(o=this.getLocalId(t[a]))&&(u=this._getBlock(0).getData(o,0),this._getBlock(0).setData(o,0,u|e));return this._getBlock(0).unlock(),[4,this.sendUpdates()];case 1:return i.sent(),[2]}})})},e.prototype.addHighlight=function(t){return r(this,void 0,void 0,function(){return i(this,function(t){return[2]})})},e.prototype.removeHighlight=function(t){return r(this,void 0,void 0,function(){return i(this,function(t){return[2]})})},e.prototype.updateFilters=function(t){return r(this,void 0,void 0,function(){var e,r,n,s,a,o,u=this;return i(this,function(i){switch(i.label){case 0:return e=t.config,r=t.service,n=t.spatialReference,s=e.filters,a=e.definitionExpression,o=s.map(function(e,i){return u._updateFilter(t,e,i,r,a,n)}),[4,l.all(o)];case 1:return i.sent(),[2]}})})},e.prototype.setAttributeBindings=function(t,e){return r(this,void 0,void 0,function(){return i(this,function(i){switch(this._hasScaleExpr=!1,t.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return[2,this._bindVVEvaluators(t.visualVariables,e)];case"dot-density":return[2,this._bindDDEvaluators(t.attributes,e)];case"heatmap":break;default:g.error(new n("attribute-store","Found invalid renderer type: "+t))}return[2]})})},e.prototype.setData=function(t,e,i,r){this._getBlock(e).setData(t,i,r)},e.prototype.setAttributeData=function(t,e,i,r){var n=this,s=t;this._getBlock(0).setData(s,0,this._getFilterFlags(e));var a=this._attributeComputeMap,u=m.oesTextureFloat?1:2;a.forEach(function(t,a){var l=a*u%4,c=Math.floor(a*u/4),h=n._getBlock(c+_.ATTRIBUTE_DATA_VV),p=t(e,{$view:r},i);if(m.oesTextureFloat)h.setData(s,l,p);else if(p===d.definitions.NAN_MAGIC_NUMBER)h.setData(s,l,255),h.setData(s,l+1,255);else{var f=o.clamp(Math.round(p),-32767,32766)+32768,y=255&f,g=(65280&f)>>8;h.setData(s,l,y),h.setData(s,l+1,g)}})},e.prototype.sendUpdates=function(){var t=this;if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=l.createResolver(),this._nextUpdate.promise;var e=this._blocks.map(function(t){return u.isSome(t)?t.toMessage():null}),i={blocks:e};return this._currUpdate=this._createResources().then(function(){var e=function(){if(t._currUpdate=null,t._nextUpdate){var e=t._nextUpdate;t._nextUpdate=null,t.sendUpdates().then(function(){return e.resolve()})}},r=t._client.update(i,t._signal).then(e);return t._client.render(),r}),this._currUpdate},e.prototype._createResources=function(){var t=this;if(u.isSome(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(_.ATTRIBUTE_DATA_ANIMATION),b("Initializing AttributeStore");var e={shared:m.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:u.mapMany(this._blocks,function(t){return{textureOnly:t.textureOnly,buffer:t.buffer,pixelType:t.pixelType}})},i=this._client.initialize(e,this._signal);return this._createResourcesPromise=i,i.then(function(){return u.isNone(t._createResourcesPromise)?t._createResources():void 0}),i},e.prototype._getBlock=function(t){var e=this._blocks[t];if(u.isSome(e))return e;b("Initializing AttributeBlock at index "+t);var i=m.sharedArrayBuffer,r=this._client.type,n=new x(i,r,this._size,this._blockDescriptors[t]);return this._blocks[t]=n,this._createResourcesPromise=null,n},e.prototype._expand=function(){if(this._size<m.maxTextureSize){var t=this._size<<=1;return b("Expanding block size to",t,this._blocks),u.forEachSome(this._blocks,function(e){return e.expand(t)}),this._createResourcesPromise=null,this._size=t,0}return g.error(new n("mapview-limitations","Maximum number of onscreen features exceeded.")),-1},e.prototype._getFreeId=function(){return this._freeList.length?this._freeList.pop():this._idCounter>=this._size*this._size&&this._expand()?-1:this._idCounter++},e.prototype._updateFilter=function(t,e,n,s,a,o){return r(this,void 0,void 0,function(){var r,l,c,h,p,d,f,_,y,g=this;return i(this,function(i){switch(i.label){case 0:return r=this._filters[n],(l=u.isSome(r)&&r.hash)===JSON.stringify(e)?[2]:(c=1<<n+1,u.isNone(e)?(this._filters[n]=null,this._idMap.forEach(function(t){var e=g._getBlock(0).getData(t,0);g._getBlock(0).setData(t,0,e|c)}),[2]):[4,t.queryObjectIds(e)]);case 1:return h=i.sent(),e.hiddenIds&&e.hiddenIds.length&&(h=h.filter(function(t){return-1===e.hiddenIds.indexOf(t)})),p=h.map(function(t){return g._idMap.get(t)}),[4,this._getFilter(n,s)];case 2:for(d=i.sent(),d.update(e,a,o),this._getBlock(0).lock(),this._idMap.forEach(function(t){var e=g._getBlock(0).getData(t,0);g._getBlock(0).setData(t,0,e&~c)}),f=0;f<p.length;f++)null!=(_=p[f])&&(y=this._getBlock(0).getData(_,0),this._getBlock(0).setData(_,0,y|c));return this._getBlock(0).unlock(),[2]}})})},e.prototype._getFilter=function(e,n){return r(this,void 0,void 0,function(){var r,s,a;return i(this,function(i){switch(i.label){case 0:return r=this._filters[e],u.isSome(r)?[2,r]:[4,new Promise(function(e,i){t(["../../../../../layers/graphics/data/FeatureFilter"],e,i)})];case 1:return s=i.sent().default,a=new s({geometryType:n.geometryType,hasM:!1,hasZ:!1,timeInfo:n.timeInfo,fieldsIndex:new c(n.fields)}),this._filters[e]=a,[2,a]}})})},e.prototype._getFilterFlags=function(t){for(var e=0,i=0;i<this._filters.length;i++){var r=this._filters[i];e|=(u.isNone(r)||r.check(t)?1:0)<<i}var n=this.getFeatureId(t.localId);return e<<1|(this._idsToHighlight.has(n)?1:0)},e.prototype._bindVVEvaluators=function(t,e){return r(this,void 0,void 0,function(){var n,s=this;return i(this,function(a){switch(a.label){case 0:return this._attributeComputeMap.clear(),u.isSome(t)?(n=l.all(t.map(function(t){return r(s,void 0,void 0,function(){var r,n;return i(this,function(i){switch(i.label){case 0:return r=d.Utils.getVVType(t.type),[4,this._createGetValueFunction(t,e)];case 1:return n=i.sent(),u.isSome(n)&&this._attributeComputeMap.set(r,n),[2]}})})})),[4,n]):[3,2];case 1:a.sent(),a.label=2;case 2:return[2]}})})},e.prototype._bindDDEvaluators=function(t,e){return r(this,void 0,void 0,function(){var r,n,s,a=this;return i(this,function(i){switch(i.label){case 0:return this._attributeComputeMap.clear(),t.length>d.definitions.DOT_DENSITY_MAX_FIELDS&&g.warn("mapview-invalid-value","DotDensityRenderer supports a maximum of "+d.definitions.DOT_DENSITY_MAX_FIELDS+" attribtues, but found "+t.length),[4,l.all(t.map(function(t){return a._createNormalizedFunction(t,e)}))];case 1:for(r=i.sent().map(function(t){return v(0,t)}),n=0;n<d.definitions.DOT_DENSITY_MAX_FIELDS;n++)s=n<t.length&&r[n],s?this._attributeComputeMap.set(n,s):this._attributeComputeMap.has(n)&&this._attributeComputeMap.delete(n);return[2]}})})},e.prototype._createGetValueFunction=function(t,e){return r(this,void 0,void 0,function(){var r,n,s,a,o,u,l;return i(this,function(i){switch(i.label){case 0:return"size"!==t.type?[3,2]:(r=d.getTypeOfSizeVisualVariable(t))===d.enums.WGLVVFlag.SIZE_SCALE_STOPS?[2,null]:(n=r===d.enums.WGLVVFlag.SIZE_UNIT_VALUE,s=n&&function(e){return y.getVisualVariableSizeValueRepresentationRatio(e,t.valueRepresentation)},a=v,o=[d.definitions.NAN_MAGIC_NUMBER],[4,this._createNormalizedFunction(t,e,s)]);case 1:return[2,a.apply(void 0,o.concat([i.sent()]))];case 2:return u=v,l=[d.definitions.NAN_MAGIC_NUMBER],[4,this._createNormalizedFunction(t,e)];case 3:return[2,u.apply(void 0,l.concat([i.sent()]))]}})})},e.prototype._createNormalizedFunction=function(t,e,s){return r(this,void 0,void 0,function(){var r,a,o;return i(this,function(i){switch(i.label){case 0:return(r=t.field)?"string"==typeof r?(a=t.normalizationField,a?[2,function(t){if(t.attributes[r]&&t.attributes[a]){var e=t.attributes[r]/t.attributes[a];return s?s(e):e}}]:[2,s?function(t){return s(t.attributes[r])}:function(t){return t.attributes[r]}]):(g.error(new n("mapview-rendering:invalid-type","The field for a vv must be a string or a number, but got "+typeof r)),[2,function(t){}]):t.valueExpression?(this._hasScaleExpr=this._hasScaleExpr||-1!==t.valueExpression.indexOf("scale"),[4,h.createVVExpression(t.valueExpression,e.spatialReference,e.fields)]):[3,2];case 1:return o=i.sent(),[2,f.callWithOptimizedFeature.bind(null,o)];case 2:return g.error("Unable to create a normalized function for visual variable: "+t),[2,function(t){}]}})})},e}();e.default=T});