// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/assignHelper","../../../../core/Error","../../../../core/promiseUtils","../../../../geometry/support/coordsUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/spatialReferenceUtils","../../featureConversionUtils","../../data/FeatureStore","../../data/projectionSupport","../../data/QueryEngine","./clientSideDefaults","./sourceUtils","../../../support/FieldsIndex","../../../support/fieldType","../../../support/fieldUtils"],function(e,t,i,r,n,s,a,u,o,l,d,p,c,f,y,h,g,m,F){function b(e){return o.isPoint(e)?null!=e.z:!!e.hasZ}function I(e){return o.isPoint(e)?null!=e.m:!!e.hasM}function v(e,t,i){if(e.geometry&&"rings"in e.geometry&&e.geometry.rings&&e.geometry.rings.length>0){var r=e.geometry.rings[0];u.isClockwise(r,t,i)||u.closeRingsAndFixWinding(e.geometry)}}Object.defineProperty(t,"__esModule",{value:!0});var _=l.WGS84,E={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:l.WGS84},j={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0}},T=function(){function e(){this._queryEngine=null,this._nextObjectId=null}return e.prototype.destroy=function(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=this._requiredFields=this._fieldsIndex=this._createDefaultAttributes=null},e.prototype.load=function(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){var t,r,a,u,o,l,d,h,b,I,v,T,x,R,q,D,S,w,O,M,S,A,Q,k,P,Z,C;return i(this,function(i){switch(i.label){case 0:if(t=[],r=e.features,a=this._inferLayerProperties(r,e.fields),u=e.fields||[],o=null!=e.hasM?e.hasM:a.hasM,l=null!=e.hasZ?e.hasZ:a.hasZ,d=!e.spatialReference&&!a.spatialReference,h=d?_:e.spatialReference||a.spatialReference,b=d?E:null,I=e.geometryType||a.geometryType,v=e.objectIdField||a.objectIdField,T=e.timeInfo,d&&t.push({name:"feature-layer:spatial-reference-not-found",message:"Spatial reference not provided or found in features. Defaults to WGS84"}),!I)throw new s("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");if(!v)throw new s("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields");for(a.objectIdField&&v!==a.objectIdField&&(t.push({name:"feature-layer:duplicated-oid-field",message:'Provided objectIdField "'+v+'" doesn\'t match the field name "'+a.objectIdField+'", found in the provided fields'}),v=a.objectIdField),v&&!a.objectIdField&&(x=null,R=u.some(function(e){return e.name===v&&(x=e,!0)}),R?(x.type="esriFieldTypeOID",x.editable=!1,x.nullable=!1):u.unshift({alias:v,name:v,type:"esriFieldTypeOID",editable:!1,nullable:!1})),q=0,D=u;q<D.length;q++){if(S=D[q],null==S.name&&(S.name=S.alias),null==S.alias&&(S.alias=S.name),!S.name)throw new s("feature-layer:invalid-field-name","field name is missing",{field:S});if(S.name===v&&(S.type="esriFieldTypeOID"),-1===m.kebabDict.jsonValues.indexOf(S.type))throw new s("feature-layer:invalid-field-type",'invalid type for field "'+S.name+'"',{field:S})}for(w={},this._requiredFields=[],O=0,M=u;O<M.length;O++)S=M[O],"esriFieldTypeOID"!==S.type&&"esriFieldTypeGlobalID"!==S.type&&(S.editable=null==S.editable||!!S.editable,S.nullable=null==S.nullable||!!S.nullable,A=F.getFieldDefaultValue(S),S.nullable||void 0!==A?w[S.name]=A:this._requiredFields.push(S));return this._fieldsIndex=new g(u),(this._createDefaultAttributes=y.createDefaultAttributesFunction(w,v),T&&(T.startTimeField&&(Q=this._fieldsIndex.get(T.startTimeField),Q?(T.startTimeField=Q.name,Q.type="esriFieldTypeDate"):T.startTimeField=null),T.endTimeField&&(k=this._fieldsIndex.get(T.endTimeField),k?(T.endTimeField=k.name,k.type="esriFieldTypeDate"):T.endTimeField=null),T.trackIdField&&(P=this._fieldsIndex.get(T.trackIdField),P?T.trackIdField=P.name:(T.trackIdField=null,t.push({name:"feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:T}}))),T.startTimeField||T.endTimeField||(t.push({name:"feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing or invalid",details:{timeInfo:T}}),T=null)),Z={warnings:t,featureErrors:[],layerDefinition:n({},j,{drawingInfo:y.createDrawingInfo(I),templates:y.createDefaultTemplate(w),extent:b,geometryType:I,objectIdField:v,fields:u,hasZ:!!l,hasM:!!o,timeInfo:T}),assignedObjectIds:{}},this._queryEngine=new f.default({fields:u,geometryType:I,hasM:o,hasZ:l,objectIdField:v,spatialReference:h,featureStore:new p.default({geometryType:I,hasM:o,hasZ:l}),timeInfo:T}),r&&r.length)?(C=r.reduce(function(e,t){var i=t.attributes&&t.attributes[v];return null==i||isNaN(i)||!isFinite(i)?e:Math.max(e,i)},0),this._nextObjectId=1+C,[4,c.checkProjectionSupport(r,h)]):(this._nextObjectId=1,[2,Z]);case 1:return i.sent(),[2,this._loadInitialFeatures(Z,r)]}})})},e.prototype.applyEdits=function(e){return r(this,void 0,void 0,function(){var t;return i(this,function(i){switch(i.label){case 0:return t=this._queryEngine.spatialReference,[4,a.all([c.checkProjectionSupport(e.adds,t),c.checkProjectionSupport(e.updates,t)])];case 1:return i.sent(),[2,this._applyEdits(e)]}})})},e.prototype.queryFeatures=function(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){return i(this,function(i){return[2,this._queryEngine.executeQuery(e,t.signal)]})})},e.prototype.queryFeatureCount=function(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){return i(this,function(i){return[2,this._queryEngine.executeQueryForCount(e,t.signal)]})})},e.prototype.queryObjectIds=function(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){return i(this,function(i){return[2,this._queryEngine.executeQueryForIds(e,t.signal)]})})},e.prototype.queryExtent=function(e,t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){return i(this,function(i){return[2,this._queryEngine.executeQueryForExtent(e,t.signal)]})})},e.prototype._inferLayerProperties=function(e,t){for(var i=void 0,r=void 0,n=null,s=null,a=null,u=0,l=e;u<l.length;u++){var d=l[u],p=d.geometry;if(p&&(n||(n=o.getJsonType(p)),s||(s=p.spatialReference),null==i&&(i=b(p)),null==r&&(r=I(p)),n&&s&&null!=i&&null!=r))break}if(t&&t.length){var c=null;t.some(function(e){var t="esriFieldTypeOID"===e.type,i=!e.type&&e.name&&"objectid"===e.name.toLowerCase();return c=e,t||i})&&(a=c.name)}return{geometryType:n,spatialReference:s,objectIdField:a,hasM:r,hasZ:i}},e.prototype._loadInitialFeatures=function(e,t){for(var i=this._queryEngine,r=i.geometryType,n=i.hasM,s=i.hasZ,a=i.objectIdField,u=i.spatialReference,l=i.featureStore,p=[],f=0,y=t;f<y.length;f++){var g=y[f];if(null!=g.uid&&(e.assignedObjectIds[g.uid]=-1),g.geometry&&r!==o.getJsonType(g.geometry))e.featureErrors.push(h.createFeatureEditErrorResult("Incorrect geometry type."));else{var m=this._createDefaultAttributes(),F=h.mixAttributes(this._fieldsIndex,this._requiredFields,m,g.attributes,!0,e.warnings);F?e.featureErrors.push(F):(this._assignObjectId(m,g.attributes,!0),g.attributes=m,null!=g.uid&&(e.assignedObjectIds[g.uid]=g.attributes[a]),g.geometry&&(v(g,n,s),g.geometry=c.project(g.geometry,g.geometry.spatialReference,u)),p.push(g))}}if(l.addMany(d.convertFromFeatures([],p,r,s,n,a)),e.layerDefinition.extent=this._queryEngine.fullExtent,e.layerDefinition.timeInfo){var b=this._queryEngine.timeExtent,I=b.start,_=b.end;e.layerDefinition.timeInfo.timeExtent=[I,_]}return e},e.prototype._applyEdits=function(e){var t=e.adds,i=e.updates,r=e.deletes,n={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t&&t.length&&this._applyAddEdits(n,t),i&&i.length&&this._applyUpdateEdits(n,i),r&&r.length){for(var s=0,a=r;s<a.length;s++){var u=a[s];n.deleteResults.push(h.createFeatureEditSuccessResult(u))}this._queryEngine.featureStore.removeManyById(r)}return{fullExtent:this._queryEngine.fullExtent,featureEditResults:n}},e.prototype._applyAddEdits=function(e,t){for(var i=e.addResults,r=this._queryEngine,n=r.geometryType,s=r.hasM,a=r.hasZ,u=r.objectIdField,l=r.spatialReference,p=r.featureStore,f=[],y=0,g=t;y<g.length;y++){var m=g[y];if(v(m,s,a),m.geometry&&n!==o.getJsonType(m.geometry))i.push(h.createFeatureEditErrorResult("Incorrect geometry type."));else{var F=this._createDefaultAttributes(),b=h.mixAttributes(this._fieldsIndex,this._requiredFields,F,m.attributes);if(b)i.push(b);else{if(this._assignObjectId(F,m.attributes),m.attributes=F,null!=m.uid){var I=m.attributes[u];e.uidToObjectId[m.uid]=I}m.geometry&&(m.geometry=c.project(m.geometry,m.geometry.spatialReference,l)),f.push(m),i.push(h.createFeatureEditSuccessResult(m.attributes[u]))}}}p.addMany(d.convertFromFeatures([],f,n,a,s,u))},e.prototype._applyUpdateEdits=function(e,t){for(var i=e.updateResults,r=this._queryEngine,n=r.geometryType,s=r.hasM,a=r.hasZ,u=r.objectIdField,l=r.spatialReference,p=r.featureStore,f=0,y=t;f<y.length;f++){var g=y[f],m=g.attributes,F=g.geometry,b=m&&m[u];if(null!=b)if(p.has(b)){var I=d.convertToFeature(p.getFeature(b),n,a,s);if(F){if(n!==o.getJsonType(F)){i.push(h.createFeatureEditErrorResult("Incorrect geometry type."));continue}I.geometry=c.project(F,F.spatialReference,l),v(I,s,a)}if(m){var _=h.mixAttributes(this._fieldsIndex,this._requiredFields,I.attributes,m);if(_){i.push(_);continue}}p.add(d.convertFromFeature(I,n,a,s,u)),i.push(h.createFeatureEditSuccessResult(b))}else i.push(h.createFeatureEditErrorResult("Feature with object id "+b+" missing"));else i.push(h.createFeatureEditErrorResult("Identifier field "+u+" missing"))}},e.prototype._assignObjectId=function(e,t,i){void 0===i&&(i=!1);var r=this._queryEngine.objectIdField;i&&t&&isFinite(t[r])?e[r]=t[r]:e[r]=this._nextObjectId++},e}();t.default=T});